# M12: Migration Intelligence (AI-assistable)

This file captures additional design-time details and interaction models for M12.

## Intent
M12 is a design-time authoring assistant for schema migrations. It does not change
runtime behavior. It reduces ambiguity and manual effort when creating migrations
by producing a structured diff, a proposed plan, and a migration stub, while
explicitly surfacing unresolved decisions for human review.

## Where It Fits In The Lifecycle
1. Design: draft schema changes.
2. Diff: compute a structured diff between old and new schema specs.
3. Plan: propose migration operations and identify ambiguity.
4. Review: human resolves ambiguous items and approves risk flags.
5. Generate: emit migration stub and report for implementation and tests.
6. Runtime: existing upcast paths remain deterministic and unchanged.

## Proposed Interaction Model (Modular, Tool-Friendly)
### A. Deterministic pipeline
- `schemalution diff` -> `diff.json`
- `schemalution plan` -> `plan.json` + `questions.json`
- `schemalution generate` -> migration stub + `report.json`

### B. Single-shot convenience
- `schemalution generate-migration --from <old> --to <new> --out <file>`
- Produces migration stub + report in one step.

### C. Human-in-the-loop resolution
- `questions.json` enumerates ambiguous decisions with options and rationale.
- `resolutions.json` is a simple key/value map of user choices.
- `schemalution generate` consumes `resolutions.json` to finalize output.

## JSON Contracts (v1)
These artifacts are intentionally simple and stable to enable IDEs, CI, and agents
without a Python dependency.

- `diff.json`
  - `changes[]`: atomic diffs with `path`, `kind`, `before`, `after`
- `plan.json`
  - `ops[]`: proposed ops DSL steps with `confidence`
  - `questions[]`: unresolved items requiring human input
  - `risks[]`: removals, type narrowing, and data-loss candidates
- `resolutions.json`
  - map of question_id -> selected_option
- `report.json`
  - `auto_handled[]`, `user_handled[]`, `unresolved[]`, `risk_summary`

## Heuristics (Initial Scope)
- rename: same type + similar name + same nesting depth
- move: same name/type, different path
- cast: compatible type changes with explicit cast
- default: new required field with default value
- coalesce: merge multiple old fields into a new target

## Non-Goals
- No runtime inference or automatic production changes.
- No ML dependency required for MVP.

## Risks
- Overconfident heuristics could hide ambiguity.
  - Mitigation: always emit `questions.json` when confidence < threshold and
    require explicit resolution.
- Conflicting changes (rename vs add/remove) can mislead plans.
  - Mitigation: surface conflicts in `plan.json` with rationale and options.
