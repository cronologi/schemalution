# M9: Registry Export + CLI JSON I/O

This file captures refinement details for M9 prior to implementation.

## Intent
Make schemalution usable by any tool or agent via a stable CLI with JSON input/output.
This is design- and tool-facing infrastructure: deterministic, machine-readable, and
versioned. No runtime behavior changes to core migration semantics.

## User Experience (CLI)
### 1) Registry export
```
schemalution registry export --format v1 --out registry.json
schemalution registry export --format v1 --dot --out registry.dot
```
Purpose: expose schema packs and migration graph to non-Python tooling.

### 2) Upcast (stdin JSON -> stdout JSON)
```
cat record.json | schemalution upcast --schema-id crm.customer --format v1
```

### 3) Validate (stdin JSON -> stdout JSON)
```
cat record.json | schemalution validate --schema-id crm.customer --format v1
```

## Design Goals
- Deterministic outputs for identical inputs.
- Strictly machine-readable JSON on stdout in `--format v1`.
- Human-readable logs go to stderr only.
- Backward compatible CLI behavior (if any existing commands).
- No hidden I/O; all data flows via stdin/args and registry.

## Output Formats (v1)
Schema file: `docs/cli/format-v1.schema.json`.

### Common envelope
All CLI JSON outputs include:
- `format`: "v1"
- `schema_id`
- `command`: "registry.export" | "upcast" | "validate"
- `success`: bool
- `errors[]` (empty when success)

### `upcast` output
- `input_version`
- `output_version` (latest)
- `record` (latest-shape record)
- `warnings[]` (from diagnostics)
- `unknown_fields[]` (from diagnostics)
- `trace[]` (optional, if `--trace`)

### `validate` output
- `is_valid`: bool
- `violations[]` (paths/messages)
- `warnings[]`

Note: in M9, `validate` means "can be upcast to latest without error"; contract validation
is deferred to M11.

### `registry export` output
- `schema_ids[]`
- `latest_versions{schema_id: int}`
- `migrations[]` (edges: from_version, to_version, op_count)
- `packs[]` (name, version, schema_ids)

## Error Handling
- Non-zero exit code on failure.
- `errors[]` entries include:
  - `code` (stable identifier)
  - `message`
  - `details` (optional, includes schema_id/from/to when relevant)
- JSON errors still emitted on stdout when `--format v1`.

## Flags (proposed)
- `--format v1` (default for JSON output)
- `--schema-id <id>` (required for upcast/validate)
- `--stdin` or default to stdin for record input
- `--trace` (emit migration path/steps)
- `--dot` for registry export
- `--out <file>` for registry export

## Integration Notes
- Stable JSON makes this usable from IDEs, agents, CI, and external tools.
- JSON Schema for v1 outputs should be included and tested.
- Keep adapter usage optional; registry should be built from installed packs.

## Tests (planned)
- Golden-output CLI tests for upcast/validate/registry export.
- JSON schema validation tests for all v1 outputs.
- Error-path tests: missing schema_id, unsupported version, invalid input JSON.

## Open Questions
- Should `--format v1` be required or defaulted for JSON outputs?
- Should `validate` use pack contracts if available, or only envelope checks?
- Should `registry export` include full migration DSL steps or only edge metadata?
- Should `validate` gain an optional `--strict` mode (warnings become failures), or remain upcast-only until M11?
